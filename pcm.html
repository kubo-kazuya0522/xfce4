<!DOCTYPE html>
<html>
<body>
<h2>PCM streaming (WebSocket)</h2>
<button id="start">音声再生を開始</button>
<div>遅延の体感: 2〜3秒くらい</div>

<script>
let audioCtx;
let ws;

document.getElementById("start").onclick = () => {
  audioCtx = new AudioContext({ sampleRate: 16000 });
  ws = new WebSocket(location.origin.replace("https", "wss") + "/pcm-ws");
  ws.binaryType = "arraybuffer";

  ws.onmessage = (event) => {
    const pcm = new Int16Array(event.data);
    const float32 = new Float32Array(pcm.length);

    for (let i = 0; i < pcm.length; i++) {
      float32[i] = pcm[i] / 32768;
    }

    const buffer = audioCtx.createBuffer(1, float32.length, 16000);
    buffer.copyToChannel(float32, 0);

    const src = audioCtx.createBufferSource();
    src.buffer = buffer;
    src.connect(audioCtx.destination);
    src.start();
  };
};
</script>
</body>
</html>
